import _objectSpread from"@babel/runtime/helpers/objectSpread";import _slicedToArray from"@babel/runtime/helpers/slicedToArray";import _regeneratorRuntime from"@babel/runtime/regenerator";import _classCallCheck from"@babel/runtime/helpers/classCallCheck";import _createClass from"@babel/runtime/helpers/createClass";import _possibleConstructorReturn from"@babel/runtime/helpers/possibleConstructorReturn";import _getPrototypeOf from"@babel/runtime/helpers/getPrototypeOf";import _inherits from"@babel/runtime/helpers/inherits";var _jsxFileName="/Users/trensik/dev/react-native-paper/src/components/Menu/Menu.tsx";import*as React from'react';import{Platform,StyleSheet,Animated,BackHandler,Dimensions,Easing,I18nManager,TouchableWithoutFeedback,View,ScrollView,findNodeHandle}from'react-native';import{withTheme}from'../../core/theming';import Portal from'../Portal/Portal';import Surface from'../Surface';import MenuItem from'./MenuItem';import{APPROX_STATUSBAR_HEIGHT}from'../../constants';var SCREEN_INDENT=8;var ANIMATION_DURATION=250;var EASING=Easing.bezier(0.4,0,0.2,1);var Menu=function(_React$Component){_inherits(Menu,_React$Component);function Menu(){var _getPrototypeOf2;var _this;_classCallCheck(this,Menu);for(var _len=arguments.length,args=new Array(_len),_key=0;_key<_len;_key++){args[_key]=arguments[_key];}_this=_possibleConstructorReturn(this,(_getPrototypeOf2=_getPrototypeOf(Menu)).call.apply(_getPrototypeOf2,[this].concat(args)));_this.state={rendered:_this.props.visible,top:0,left:0,menuLayout:{width:0,height:0},anchorLayout:{width:0,height:0},opacityAnimation:new Animated.Value(0),scaleAnimation:new Animated.ValueXY({x:0,y:0})};_this._anchor=null;_this._menu=null;_this._isAnchorCoord=function(){return!React.isValidElement(_this.props.anchor);};_this._measureMenuLayout=function(){return new Promise(function(resolve){if(_this._menu){_this._menu.measureInWindow(function(x,y,width,height){resolve({x:x,y:y,width:width,height:height});});}});};_this._measureAnchorLayout=function(){return new Promise(function(resolve){var anchor=_this.props.anchor;if(_this._isAnchorCoord()){resolve({x:anchor.x,y:anchor.y,width:0,height:0});return;}if(_this._anchor){_this._anchor.measureInWindow(function(x,y,width,height){resolve({x:x,y:y,width:width,height:height});});}});};_this._updateVisibility=function _callee(){return _regeneratorRuntime.async(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.next=2;return _regeneratorRuntime.awrap(Promise.resolve());case 2:if(_this.props.visible){_this._show();}else{_this._hide();}case 3:case"end":return _context.stop();}}});};_this._isBrowser=function(){return'document'in global;};_this._focusFirstDOMNode=function(el){if(el&&_this._isBrowser()){var node=findNodeHandle(el);var focusableNode=node.querySelector('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');focusableNode&&focusableNode.focus();}};_this._handleDismiss=function(){if(_this.props.visible){_this.props.onDismiss();}return true;};_this._handleKeypress=function(e){if(e.key==='Escape'){_this.props.onDismiss();}};_this._attachListeners=function(){BackHandler.addEventListener('hardwareBackPress',_this._handleDismiss);Dimensions.addEventListener('change',_this._handleDismiss);_this._isBrowser()&&document.addEventListener('keyup',_this._handleKeypress);};_this._removeListeners=function(){BackHandler.removeEventListener('hardwareBackPress',_this._handleDismiss);Dimensions.removeEventListener('change',_this._handleDismiss);_this._isBrowser()&&document.removeEventListener('keyup',_this._handleKeypress);};_this._show=function _callee2(){var windowLayout,_ref,_ref2,menuLayout,anchorLayout;return _regeneratorRuntime.async(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:windowLayout=Dimensions.get('window');_context2.next=3;return _regeneratorRuntime.awrap(Promise.all([_this._measureMenuLayout(),_this._measureAnchorLayout()]));case 3:_ref=_context2.sent;_ref2=_slicedToArray(_ref,2);menuLayout=_ref2[0];anchorLayout=_ref2[1];if(!(!windowLayout.width||!windowLayout.height||!menuLayout.width||!menuLayout.height||!anchorLayout.width&&!_this._isAnchorCoord()||!anchorLayout.height&&!_this._isAnchorCoord())){_context2.next=10;break;}requestAnimationFrame(_this._show);return _context2.abrupt("return");case 10:_this.setState(function(){return{left:anchorLayout.x,top:anchorLayout.y,anchorLayout:{height:anchorLayout.height,width:anchorLayout.width},menuLayout:{width:menuLayout.width,height:menuLayout.height}};},function(){_this._attachListeners();var animation=_this.props.theme.animation;Animated.parallel([Animated.timing(_this.state.scaleAnimation,{toValue:{x:menuLayout.width,y:menuLayout.height},duration:ANIMATION_DURATION*animation.scale,easing:EASING,useNativeDriver:true}),Animated.timing(_this.state.opacityAnimation,{toValue:1,duration:ANIMATION_DURATION*animation.scale,easing:EASING,useNativeDriver:true})]).start(function(_ref3){var finished=_ref3.finished;if(finished){_this._focusFirstDOMNode(_this._menu);}});});case 11:case"end":return _context2.stop();}}});};_this._hide=function(){_this._removeListeners();var animation=_this.props.theme.animation;Animated.timing(_this.state.opacityAnimation,{toValue:0,duration:ANIMATION_DURATION*animation.scale,easing:EASING,useNativeDriver:true}).start(function(finished){if(finished){_this.setState({menuLayout:{width:0,height:0}});_this.state.scaleAnimation.setValue({x:0,y:0});_this._focusFirstDOMNode(_this._anchor);_this.setState({rendered:false});}});};return _this;}_createClass(Menu,[{key:"componentDidUpdate",value:function componentDidUpdate(prevProps){if(prevProps.visible!==this.props.visible){this._updateVisibility();}}},{key:"componentWillUnmount",value:function componentWillUnmount(){this._removeListeners();}},{key:"render",value:function render(){var _this2=this;var _this$props=this.props,visible=_this$props.visible,anchor=_this$props.anchor,contentStyle=_this$props.contentStyle,style=_this$props.style,children=_this$props.children,theme=_this$props.theme,statusBarHeight=_this$props.statusBarHeight,onDismiss=_this$props.onDismiss;var _this$state=this.state,rendered=_this$state.rendered,menuLayout=_this$state.menuLayout,anchorLayout=_this$state.anchorLayout,opacityAnimation=_this$state.opacityAnimation,scaleAnimation=_this$state.scaleAnimation;var _this$state2=this.state,left=_this$state2.left,top=_this$state2.top;var additionalVerticalValue=Platform.select({android:statusBarHeight,default:0});var scaleTransforms=[{scaleX:scaleAnimation.x.interpolate({inputRange:[0,menuLayout.width],outputRange:[0,1]})},{scaleY:scaleAnimation.y.interpolate({inputRange:[0,menuLayout.height],outputRange:[0,1]})}];var windowLayout=Dimensions.get('window');var positionTransforms=[];if(left<=windowLayout.width-menuLayout.width-SCREEN_INDENT){positionTransforms.push({translateX:scaleAnimation.x.interpolate({inputRange:[0,menuLayout.width],outputRange:[-(menuLayout.width/2),0]})});if(left<SCREEN_INDENT){left=SCREEN_INDENT;}}else{positionTransforms.push({translateX:scaleAnimation.x.interpolate({inputRange:[0,menuLayout.width],outputRange:[menuLayout.width/2,0]})});left+=anchorLayout.width-menuLayout.width;var right=left+menuLayout.width;if(right>windowLayout.width-SCREEN_INDENT){left=windowLayout.width-SCREEN_INDENT-menuLayout.width;}}var scrollableMenuHeight=0;if(top>=windowLayout.height-menuLayout.height-SCREEN_INDENT-additionalVerticalValue&&top<=windowLayout.height-top){scrollableMenuHeight=windowLayout.height-top-SCREEN_INDENT-additionalVerticalValue;}else if(top>=windowLayout.height-menuLayout.height-SCREEN_INDENT-additionalVerticalValue&&top>=windowLayout.height-top&&top<=menuLayout.height-anchorLayout.height+SCREEN_INDENT-additionalVerticalValue){scrollableMenuHeight=top+anchorLayout.height-SCREEN_INDENT+additionalVerticalValue;}scrollableMenuHeight=scrollableMenuHeight>windowLayout.height-2*SCREEN_INDENT?windowLayout.height-2*SCREEN_INDENT:scrollableMenuHeight;if(top<=windowLayout.height-menuLayout.height-SCREEN_INDENT-additionalVerticalValue||top>=windowLayout.height-menuLayout.height-SCREEN_INDENT-additionalVerticalValue&&top<=windowLayout.height-top){positionTransforms.push({translateY:scaleAnimation.y.interpolate({inputRange:[0,menuLayout.height],outputRange:[-((scrollableMenuHeight||menuLayout.height)/2),0]})});if(top<SCREEN_INDENT){top=SCREEN_INDENT;}}else{positionTransforms.push({translateY:scaleAnimation.y.interpolate({inputRange:[0,menuLayout.height],outputRange:[(scrollableMenuHeight||menuLayout.height)/2,0]})});top+=anchorLayout.height-(scrollableMenuHeight||menuLayout.height);var bottom=top+(scrollableMenuHeight||menuLayout.height)+additionalVerticalValue;if(bottom>windowLayout.height-SCREEN_INDENT){top=scrollableMenuHeight===windowLayout.height-2*SCREEN_INDENT?-SCREEN_INDENT*2:windowLayout.height-menuLayout.height-SCREEN_INDENT-additionalVerticalValue;}}var shadowMenuContainerStyle=_objectSpread({opacity:opacityAnimation,transform:scaleTransforms,borderRadius:theme.roundness},scrollableMenuHeight?{height:scrollableMenuHeight}:{});var positionStyle=_objectSpread({top:this._isAnchorCoord()?top:top+additionalVerticalValue},I18nManager.isRTL?{right:left}:{left:left});return React.createElement(View,{ref:function ref(_ref5){_this2._anchor=_ref5;},collapsable:false,__source:{fileName:_jsxFileName,lineNumber:531}},this._isAnchorCoord()?null:anchor,rendered?React.createElement(Portal,{__source:{fileName:_jsxFileName,lineNumber:539}},React.createElement(TouchableWithoutFeedback,{onPress:onDismiss,__source:{fileName:_jsxFileName,lineNumber:540}},React.createElement(View,{style:StyleSheet.absoluteFill,__source:{fileName:_jsxFileName,lineNumber:541}})),React.createElement(View,{ref:function ref(_ref4){_this2._menu=_ref4;},collapsable:false,accessibilityViewIsModal:visible,style:[styles.wrapper,positionStyle,style],pointerEvents:visible?'box-none':'none',__source:{fileName:_jsxFileName,lineNumber:543}},React.createElement(Animated.View,{style:{transform:positionTransforms},__source:{fileName:_jsxFileName,lineNumber:552}},React.createElement(Surface,{style:[styles.shadowMenuContainer,shadowMenuContainerStyle,contentStyle],__source:{fileName:_jsxFileName,lineNumber:553}},scrollableMenuHeight&&React.createElement(ScrollView,{__source:{fileName:_jsxFileName,lineNumber:563}},children)||React.createElement(React.Fragment,{__source:{fileName:_jsxFileName,lineNumber:564}},children))))):null);}}],[{key:"getDerivedStateFromProps",value:function getDerivedStateFromProps(nextProps,prevState){if(nextProps.visible&&!prevState.rendered){return{rendered:true};}return null;}}]);return Menu;}(React.Component);Menu.Item=MenuItem;Menu.defaultProps={statusBarHeight:APPROX_STATUSBAR_HEIGHT};var styles=StyleSheet.create({wrapper:{position:'absolute'},shadowMenuContainer:{opacity:0,paddingVertical:8,elevation:8}});export default withTheme(Menu);
//# sourceMappingURL=Menu.js.map